<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Reports</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .status { padding: 0.3rem 0.8rem; border-radius: 15px; color: white; font-weight: 600; }
        .status-pending { background-color: #ffc107; }
        .status-resolved { background-color: #28a745; }
        .feedback-form { margin-top: 1.5rem; border-top: 1px solid #eee; padding-top: 1.5rem; }
    </style>
</head>
<body>
    <nav class="navbar"><div class="container nav-container"><a href="/" class="logo">CivicConnect</a><ul class="nav-links"><li><a href="/">Home</a></li><li><button onclick="logout()" class="btn btn-primary">Logout</button></li></ul></div></nav>
    <div class="dashboard-container">
        <div class="dashboard-header"><h1>My Submitted Reports</h1></div>
        <div class="form-container" style="margin: 0 0 3rem 0; padding: 2rem;">
            <h2>Submit a New Report</h2>
            <form id="reportForm">
                <label for="caption">Caption:</label><input type="text" id="caption" required>
                <label for="category">Category:</label>
                <select id="category" required><option value="waste">Waste Management</option><option value="traffic">Traffic Management</option><option value="infra">Public Infrastructure</option><option value="other">Other</option></select>
                <label for="image">Image:</label><input type="file" id="image" accept="image/*" required>
                <button type="submit">Submit Report</button>
            </form>
        </div>
        <hr>
        <h2>My Reports History</h2>
        <div id="reports-container"></div>
    </div>
    
    <script>
        const token = localStorage.getItem('accessToken');
        if (!token) { window.location.href = '/login'; }

        function formatStatusText(status) {
            return status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        async function fetchReports() {
            const response = await fetch(`/api/reports?token=${token}`);
            const reports = await response.json();
            const container = document.getElementById('reports-container');
            container.innerHTML = '';
            if (reports.length === 0) {
                container.innerHTML = '<p>You have not submitted any reports yet.</p>';
                return;
            }
            reports.forEach(report => {
                const statusClass = `status-${report.status}`;
                const statusText = formatStatusText(report.status);
                let feedbackSection = '';

                if (report.status === 'resolved') {
                    feedbackSection = `
                        <div class="feedback-form">
                            <h4>Leave Feedback</h4>
                            <form onsubmit="submitFeedback(event, ${report.id})">
                                <label>Rating (1-5):</label>
                                <input type="number" min="1" max="5" placeholder="5" required>
                                <label>Comment (Optional):</label>
                                <textarea placeholder="Great work!"></textarea>
                                <button type="submit">Submit Feedback</button>
                            </form>
                        </div>`;
                }

                const reportDiv = document.createElement('div');
                reportDiv.className = 'report-card';
                reportDiv.innerHTML = `
                    <h3>${report.caption}</h3>
                    <img src="/${report.image_url}" width="200" />
                    <p><strong>Status:</strong> <span class="status ${statusClass}">${statusText}</span></p>
                    <p><em>Reported at: ${new Date(report.timestamp).toLocaleString()}</em></p>
                    ${feedbackSection}
                `;
                container.appendChild(reportDiv);
            });
        }

        async function submitFeedback(event, reportId) {
            event.preventDefault();
            const form = event.target;
            const submitButton = form.querySelector('button');
            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...';
            try {
                const formData = new FormData();
                formData.append('token', token);
                formData.append('rating', form.querySelector('input[type="number"]').value);
                formData.append('comment', form.querySelector('textarea').value);

                const response = await fetch(`/api/reports/${reportId}/feedback`, { method: 'POST', body: formData });
                if (!response.ok) { throw new Error('Feedback submission failed'); }
                
                alert('Thank you for your feedback!');
                form.style.display = 'none';
            } catch(error) {
                alert('Failed to submit feedback. You may have already submitted it.');
                submitButton.disabled = false;
                submitButton.textContent = 'Submit Feedback';
            }
        }

        document.getElementById('reportForm').addEventListener('submit', function(event) {
            event.preventDefault();
            navigator.geolocation.getCurrentPosition(async (position) => {
                const form = document.getElementById('reportForm');
                const submitButton = form.querySelector('button');
                submitButton.disabled = true;
                submitButton.textContent = 'Submitting...';
                try {
                    const formData = new FormData();
                    formData.append('token', token);
                    formData.append('caption', document.getElementById('caption').value);
                    formData.append('category', document.getElementById('category').value);
                    formData.append('file', document.getElementById('image').files[0]);
                    formData.append('latitude', position.coords.latitude);
                    formData.append('longitude', position.coords.longitude);
                    formData.append('is_emergency', false);
                    const response = await fetch('/api/reports', { method: 'POST', body: formData });
                    if (!response.ok) { throw new Error('Submission failed'); }
                    alert('Complaint submitted successfully!');
                    form.reset();
                    await fetchReports();
                } catch (error) {
                    alert('There was an error submitting your complaint. Please try again.');
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Submit Report';
                }
            }, (error) => {
                alert("GPS location is required to submit a report.");
            });
        });

        function logout() { localStorage.removeItem('accessToken'); localStorage.removeItem('userRole'); window.location.href = '/login'; }
        fetchReports();
    </script>
</body>
</html>